
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Ø§Ù„Ø³Ø¨ÙˆØ±Ø© Ø§Ù„Ø°ÙƒÙŠØ© Ù„Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª Ø§Ù„Ù…Ø·ÙˆÙ‘Ø±Ø© â€” ÙƒØ§Ù…Ù„Ø© (Ø®Ù„ÙÙŠØ© Ø³Ø§Ø¯Ø© Ø§ÙØªØ±Ø§Ø¶ÙŠÙ‹Ø§)</title>
<style>
  :root{
    --primary:#1e88e5;
    --primary-2:#42a5f5;
    --bg:#f7f9fc;
    --card:#ffffff;
    --ink:#222;
    --muted:#6b7280;
    --border:#e5e7eb;
    --accent:#10b981;
    --danger:#ef4444;
    --shadow:0 10px 25px rgba(0,0,0,.08);
    --radius:18px;
    --sel:#ef4444;
  }
  *{box-sizing:border-box}
  html,body{min-height:100vh}
  body{
    margin:0;
    font-family: "Tajawal", system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Kufi Arabic", sans-serif;
    background: var(--bg);
    color: var(--ink);
    display:flex; flex-direction:column;
  }
  header{
    background: linear-gradient(135deg, var(--primary) 0%, var(--primary-2) 100%);
    color:#fff; padding:22px 22px 18px; position:relative;
    box-shadow: var(--shadow);
    border-bottom-left-radius: 22px; border-bottom-right-radius: 22px;
  }
  header h1{ margin:0; font-size: clamp(22px, 2.4vw, 36px); display:flex; align-items:center; justify-content:center; gap:12px; text-shadow: 0 2px 12px rgba(0,0,0,.25); }
  header small{display:block; text-align:center; opacity:.9; margin-top:6px; font-size:14px;}
  header img.logo{ position:absolute; right:14px; top:14px; width:86px; height:auto; filter: drop-shadow(0 2px 6px rgba(0,0,0,.25)); border-radius: 12px; background: rgba(255,255,255,.15); padding:6px; }

  .wrap{ flex:1; display:flex; flex-direction:column; gap:10px; padding:12px 16px 10px; min-height:0; }

  .toolbar{ display:flex; align-items:center; gap:10px; flex-wrap:wrap;
    background:var(--card); border:1px solid var(--border); padding:10px; border-radius: var(--radius); box-shadow: var(--shadow); }
  .button{
    background:#fff; border:1px solid var(--border); border-radius:14px; padding:9px 12px;
    font-size:14px; display:inline-flex; align-items:center; gap:7px; cursor:pointer; transition:.15s ease;
    box-shadow: 0 2px 6px rgba(0,0,0,.04); user-select:none;
  }
  .button:hover{transform:translateY(-1px)}
  .button.active{background:#eef6ff; border-color:#bfdbfe}
  .button.danger{background:#fff5f5; border-color:#fecaca; color:#b91c1c}
  .button:disabled{opacity:.5; cursor:not-allowed;}
  .spacer{flex:1}
  .panel{display:flex; gap:10px; align-items:center; flex-wrap:wrap; padding:6px 8px; background:#f9fafb; border:1px dashed var(--border); border-radius:14px;}
  label{font-size:13px;color:var(--muted)}
  .input{
    padding:8px 10px; border:1px solid var(--border); border-radius:12px; min-width: 210px; font-size:14px;
  }

  .board{position:relative; flex:1; min-height:520px; border-radius: var(--radius); background:#fff; border:1px solid var(--border); overflow:hidden; box-shadow: var(--shadow);}
  .board.theme-dark{ background:#0d1117; border-color:#1f2937; }
  #gridCanvas,#axisCanvas,#numberLineCanvas,#draw{ position:absolute; inset:0; }
  #draw{ cursor: crosshair; } /* Ø§Ù„Ø®Ù„ÙÙŠØ© Ø³ØªÙØ¶Ø¨Ø· Ù…Ù† JS Ø­Ø³Ø¨ Ø§Ù„Ù†Ù…Ø· */

  .overlay{ position:absolute; inset:0; pointer-events:none; }
  .draggable{ position:absolute; top:140px; left:160px; pointer-events:auto; touch-action:none; user-select:none; }
  .selected{ outline:2px dashed var(--sel); outline-offset:2px; }

  .box{ box-shadow: var(--shadow); border:1px solid #d1d5db; background:#fff; border-radius:12px; }
  .box img{ display:block; width:100%; height:100%; object-fit:contain; border-radius:12px; }
  .shape{ background:rgba(37,99,235,.08); border:2px solid #2563eb; }
  .shape.square{ aspect-ratio:1/1; }
  .resize-handle{
    position:absolute; width:14px; height:14px; border-radius:50%;
    background:#fff; border:2px solid var(--sel); box-shadow: 0 2px 6px rgba(0,0,0,.15);
  }
  .handle-nw{ left:-8px; top:-8px; cursor:nwse-resize }
  .handle-ne{ right:-8px; top:-8px; cursor:nesw-resize }
  .handle-sw{ left:-8px; bottom:-8px; cursor:nesw-resize }
  .handle-se{ right:-8px; bottom:-8px; cursor:nwse-resize }

  .framebar{ position:absolute; left:0; right:0; top:0; height:36px; display:flex; align-items:center; gap:10px; background:rgba(30,136,229,.95); color:#fff; padding:6px 10px; border-top-left-radius:12px; border-top-right-radius:12px; cursor:move; }
  .framebar a{ color:#fff; text-decoration:underline; font-size:13px }
  .framebar .title{font-weight:700}
  .framebar .grow{ flex:1 }
  .framebar button.close{ background:#ffffff22; border:1px solid #ffffff55; color:#fff; padding:4px 8px; border-radius:10px; cursor:pointer }
  .framebar button.close:hover{ background:#ffffff33 }
  .frame{ position:absolute; left:0; right:0; top:36px; bottom:0; width:100%; height:calc(100% - 36px); border:0; border-bottom-left-radius:12px; border-bottom-right-radius:12px; }

  footer{ background:#f1f5f9; border-top:1px solid var(--border); text-align:center; padding:10px 12px; font-size:14px; }
  .hint{font-size:12px;color:#374151;background:#fff; border:1px dashed #cbd5e1; padding:6px 8px; border-radius:10px; margin-top:6px}
</style>
</head>
<body>
  <header>
    <img class="logo" src="https://j.top4top.io/p_35129x4t01.png" alt="Ø´Ø¹Ø§Ø± Ø§Ù„Ù…Ù„ØªÙ‚Ù‰" />
    <h1>Ø§Ù„Ø³Ø¨ÙˆØ±Ø© Ø§Ù„Ø°ÙƒÙŠØ© Ù„Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª Ø§Ù„Ù…Ø·ÙˆÙ‘Ø±Ø© ğŸ¯</h1>
    <small>Ù†Ø³Ø®Ø© ÙƒØ§Ù…Ù„Ø© Ù…Ø¹ ÙƒÙ„ Ø§Ù„Ø£Ø¯ÙˆØ§Øª â€” Ø§Ù„Ø®Ù„ÙÙŠØ© Ø³Ø§Ø¯Ø© (Ø£Ø¨ÙŠØ¶) Ø§ÙØªØ±Ø§Ø¶ÙŠÙ‹Ø§</small>
  </header>

  <div class="wrap">
    <div class="toolbar">
      <button id="toggleDraw" class="button">âœï¸ ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø±Ø³Ù…</button>
      <div class="panel">
        <label>Ù„ÙˆÙ† Ø§Ù„Ù‚Ù„Ù…:</label>
        <input id="color" type="color" value="#1e90ff" />
        <label>Ø³ÙÙ…Ùƒ Ø§Ù„Ù‚Ù„Ù…:</label>
        <input id="size" type="range" min="1" max="30" value="4" />
        <button id="hl" class="button">ğŸ–ï¸ Ù‚Ù„Ù… ØªØ¸Ù„ÙŠÙ„</button>
        <button id="eraser" class="button">ğŸ§½ Ù…Ù…Ø­Ø§Ø©</button>
        <button id="undo" class="button">â†©ï¸ ØªØ±Ø§Ø¬Ø¹</button>
        <button id="redo" class="button">â†ªï¸ Ø¥Ø¹Ø§Ø¯Ø©</button>
        <button id="clear" class="button danger">ğŸ—‘ï¸ Ù…Ø³Ø­ Ø§Ù„Ø³Ø¨ÙˆØ±Ø©</button>
        <button id="save" class="button">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØµÙˆØ±Ø©</button>
      </div>

      <div class="panel">
        <button id="toggleRuler" class="button">ğŸ“ Ø§Ù„Ù…Ø³Ø·Ø±Ø©</button>
        <button id="toggleProtractor" class="button">ğŸŒ“ Ø§Ù„Ù…Ù†Ù‚Ù„Ø©</button>
        <button id="toggleNumLine" class="button">â€” Ø®Ø· Ø§Ù„Ø£Ø¹Ø¯Ø§Ø¯</button>
        <select id="gridType" class="button">
          <option value="none" selected>Ø¨Ø¯ÙˆÙ† Ø´Ø¨ÙƒØ©</option>
          <option value="square">Ø´Ø¨ÙƒØ© Ù…Ø±Ø¨Ø¹Ø§Øª</option>
          <option value="dots">Ø´Ø¨ÙƒØ© Ù…Ù†Ù‚Ø·Ø©</option>
          <option value="axis">Ù…Ø­Ø§ÙˆØ± Ø¥Ø­Ø¯Ø§Ø«ÙŠØ©</option>
          <option value="iso">Ø´Ø¨ÙƒØ© Ù…ØªØ³Ø§ÙˆÙŠØ© Ø§Ù„Ø£Ø¶Ù„Ø§Ø¹</option>
        </select>
      </div>

      <div class="panel">
        <button id="addSquare" class="button">â¬œ Ù…Ø±Ø¨Ø¹</button>
        <button id="addRect" class="button">â–­ Ù…Ø³ØªØ·ÙŠÙ„</button>
        <button id="textNote" class="button">ğŸ“ Ù†Øµ</button>
        <label class="button" style="cursor:pointer">
          ğŸ–¼ï¸ Ø¥Ø¯Ø±Ø§Ø¬ ØµÙˆØ±Ø©
          <input id="imgInput" type="file" accept="image/*" style="display:none">
        </label>
        <button id="textEraser" class="button danger">ğŸ§¹ Ù…Ù…Ø­Ø§Ø© Ø§Ù„Ù†Øµ</button>
        <button id="clearNotes" class="button danger">ğŸ—‘ï¸ Ù…Ø³Ø­ ÙƒÙ„ Ø§Ù„Ù†ØµÙˆØµ</button>
        <button id="deleteEl" class="button danger" disabled>ğŸ—‘ï¸ Ø­Ø°Ù Ø§Ù„Ù…Ø­Ø¯Ø¯</button>
      </div>

      <div class="panel">
        <label>Ø®Ù„ÙÙŠØ© Ø§Ù„Ø³Ø¨ÙˆØ±Ø©:</label>
        <select id="bgSelect" class="button">
          <option value="light" selected>Ø£Ø¨ÙŠØ¶</option>
          <option value="dark">Ø£Ø³ÙˆØ¯</option>
        </select>
        <label>Ù†Ù…Ø· Ø§Ù„Ø³Ø·Ø­:</label>
        <select id="patternSelect" class="button">
          <option value="plain" selected>Ø³Ø§Ø¯Ø©</option>
          <option value="striped">Ù…Ø®Ø·Ø·Ø©</option>
        </select>
        <button id="plainQuick" class="button">ğŸ¨ Ø®Ù„ÙÙŠØ© Ø³Ø§Ø¯Ø©</button>
      </div>

      <!-- Ø¥Ø¯Ø±Ø§Ø¬ Ù…Ù„Ù/Ù…Ø³ØªÙ†Ø¯ -->
      <div class="panel">
        <button id="insertFile" class="button">ğŸ“ Ø¥Ø¯Ø±Ø§Ø¬ Ù…Ù„Ù</button>
        <button id="insertFileLink" class="button">ğŸ”— Ø¥Ø¯Ø±Ø§Ø¬ Ø¹Ø¨Ø± Ø±Ø§Ø¨Ø·</button>
        <input id="filePicker" type="file" style="display:none"
          accept=".pdf,.doc,.docx,.ppt,.pptx,.xls,.xlsx,application/pdf,application/vnd.openxmlformats-officedocument.presentationml.presentation,application/vnd.openxmlformats-officedocument.wordprocessingml.document,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet,application/msword,application/vnd.ms-powerpoint,application/vnd.ms-excel" />
      </div>

      <!-- Ù„ÙˆØ­ Ø§Ù„Ø±ÙˆØ§Ø¨Ø· ÙˆØ§Ù„Ø¨Ø­Ø« -->
      <div class="panel">
        <input id="urlInput" class="input" placeholder="Ø§Ù„ØµÙ‚ÙŠ/Ø§Ù„ØµÙ‚ Ø±Ø§Ø¨Ø· Ù…ÙˆÙ‚Ø¹ Ø£Ùˆ ÙÙŠØ¯ÙŠÙˆ..." />
        <button id="openURL" class="button">ğŸŒ ÙØªØ­ Ø§Ù„Ø±Ø§Ø¨Ø·</button>
        <input id="webQuery" class="input" placeholder="Ø§Ø¨Ø­Ø« ÙÙŠ Ø§Ù„ÙˆÙŠØ¨..." />
        <button id="searchWeb" class="button">ğŸ” ÙˆÙŠØ¨</button>
        <input id="ytQuery" class="input" placeholder="Ø§Ø¨Ø­Ø« ÙÙŠ ÙŠÙˆØªÙŠÙˆØ¨ Ø£Ùˆ Ø£Ù„ØµÙ‚ Ø±Ø§Ø¨Ø· ÙÙŠØ¯ÙŠÙˆ..." />
        <button id="searchYT" class="button">â–¶ï¸ ÙŠÙˆØªÙŠÙˆØ¨</button>
      </div>

      <div class="spacer"></div>
      <button id="togglePolypad" class="button">ğŸ“š Ø¨ÙˆÙ„ÙŠ Ø¨Ø§Ø¯</button>
      <button id="toggleGeoboard" class="button">ğŸ§© Ø§Ù„Ø¬ÙŠÙˆ Ø¨ÙˆØ±Ø¯</button>
      <button id="toggleWheel" class="button">ğŸ° Ø¹Ø¬Ù„Ø© Ø§Ù„Ø£Ø³Ù…Ø§Ø¡</button>
    </div>

    <div class="board" id="board">
      <canvas id="gridCanvas"></canvas>
      <canvas id="axisCanvas"></canvas>
      <canvas id="numberLineCanvas"></canvas>
      <canvas id="draw"></canvas>

      <div class="overlay" id="overlay">
        <div id="ruler" class="draggable" style="display:none; top:60px; left:60px;">
          <svg class="box" viewBox="0 0 600 60" style="width:640px;height:60px;">
            <rect x="0" y="0" width="600" height="60" rx="10" ry="10" fill="#fff"/>
            <g id="ticks"></g>
          </svg>
        </div>

        <div id="protractor" class="draggable" style="display:none; top:160px; left:60px;">
          <svg class="box" viewBox="0 0 400 200" style="width:400px;height:200px;">
            <path d="M0,200 A200,200 0 0,1 400,200 L390,200 A190,190 0 0,0 10,200 Z" fill="#eaf2ff" stroke="#93c5fd" />
            <g id="pticks"></g>
            <text x="200" y="190" text-anchor="middle" font-size="12" fill="#2563eb">0Â° â€¦ 180Â°</text>
          </svg>
        </div>
      </div>

      <!-- Ø¹Ø§Ø±Ø¶ Ø¹Ø§Ù… -->
      <div id="viewerBox" class="draggable box" style="display:none; width:1000px; height:620px; top:100px; left:80px; z-index:25;">
        <div class="framebar" id="viewerbar">
          <span class="title">Ø¹Ø§Ø±Ø¶ Ø§Ù„ÙˆÙŠØ¨</span>
          <span id="viewerURL" style="font-size:12px; opacity:.9; direction:ltr; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:50%"></span>
          <span class="grow"></span>
          <a id="viewerOpen" href="#" target="_blank" rel="noopener">ÙØªØ­ ÙÙŠ ØªØ¨ÙˆÙŠØ¨</a>
          <button class="close" id="viewerClose">Ø¥ØºÙ„Ø§Ù‚ Ã—</button>
        </div>
        <iframe id="viewer" class="frame" src="about:blank"
          allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
          allowfullscreen referrerpolicy="no-referrer"></iframe>
        <div class="hint" id="viewerHint" style="position:absolute; left:12px; right:12px; bottom:12px;">
          Ù‚Ø¯ ØªØ±ÙØ¶ Ø¨Ø¹Ø¶ Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹ Ø§Ù„ØªØ¶Ù…ÙŠÙ† Ø¯Ø§Ø®Ù„ Ø§Ù„Ø¥Ø·Ø§Ø±. Ø¥Ù† Ø¸Ù‡Ø±Øª Ø¹Ù„Ø§Ù…Ø© Ø§Ù„Ù…Ù†Ø¹ØŒ Ø§Ø³ØªØ®Ø¯Ù… Ø²Ø± <b>ÙØªØ­ ÙÙŠ ØªØ¨ÙˆÙŠØ¨</b>.
        </div>
      </div>

      <!-- Ø¨ÙˆÙ„ÙŠ Ø¨Ø§Ø¯ -->
      <div id="polypadBox" class="draggable box" style="display:none; width:960px; height:580px; top:70px; left:60px; z-index:21;">
        <div class="framebar" id="polybar">
          <span class="title">Polypad</span>
          <span class="grow"></span>
          <a id="polyOpen" href="https://polypad.amplify.com/p" target="_blank" rel="noopener">ÙØªØ­ ÙÙŠ ØªØ¨ÙˆÙŠØ¨</a>
          <button class="close" id="polyClose">Ø¥ØºÙ„Ø§Ù‚ Ã—</button>
        </div>
        <iframe id="polyframe" class="frame" src="about:blank" allowfullscreen referrerpolicy="no-referrer"></iframe>
      </div>

      <!-- Ø§Ù„Ø¬ÙŠÙˆ Ø¨ÙˆØ±Ø¯ -->
      <div id="geoboardBox" class="draggable box" style="display:none; width:900px; height:560px; top:140px; left:110px; z-index:20;">
        <div class="framebar" id="geobar">
          <span class="title">Geoboard</span>
          <span class="grow"></span>
          <a href="https://apps.mathlearningcenter.org/geoboard/" target="_blank" rel="noopener">ÙØªØ­ ÙÙŠ ØªØ¨ÙˆÙŠØ¨</a>
          <button class="close" id="geoClose">Ø¥ØºÙ„Ø§Ù‚ Ã—</button>
        </div>
        <iframe id="geoframe" class="frame" src="https://apps.mathlearningcenter.org/geoboard/" allowfullscreen referrerpolicy="no-referrer"></iframe>
      </div>

      <!-- Ø¹Ø¬Ù„Ø© Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ -->
      <div id="wheelBox" style="display:none; position:absolute; top:12px; left:12px; width:360px; background:#fff; border:1px solid var(--border); border-radius:16px; box-shadow: var(--shadow); padding:10px; z-index:18;">
        <canvas id="wheelCanvas" width="340" height="280" style="width:100%; height:280px; display:block;"></canvas>
        <div style="display:flex; gap:6px; margin-top:6px;">
          <textarea id="names" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ø£Ø³Ù…Ø§Ø¡â€¦ ÙƒÙ„ Ø§Ø³Ù… ÙÙŠ Ø³Ø·Ø±" style="flex:1; min-height:80px"></textarea>
          <div style="display:flex; flex-direction:column; gap:6px; width:110px">
            <button id="spin" class="button">ØªØ´ØºÙŠÙ„</button>
            <button id="removeWin" class="button">Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ÙØ§Ø¦Ø²</button>
            <button id="clearNames" class="button">Ù…Ø³Ø­</button>
            <select id="sound" class="button">
              <option value="none">Ø¨Ø¯ÙˆÙ† ØµÙˆØª</option>
              <option value="applause">ØªØµÙÙŠÙ‚</option>
            </select>
          </div>
        </div>
        <small id="winner" style="display:block; margin-top:6px; color:#111"></small>
      </div>
    </div>
  </div>

  <footer>
    ØªØµÙ…ÙŠÙ… ÙˆØ¨Ø±Ù…Ø¬Ø© Ø§Ù„Ø§Ø³ØªØ§Ø°Ø© : ÙØ§Ø·Ù…Ø© Ù‡Ø²Ø§Ø²ÙŠ , ØªØ·ÙˆÙŠØ± Ø§Ù„Ø§Ø³ØªØ§Ø° : Ø¹Ø¨Ø¯ Ø§Ù„Ø¹Ø²ÙŠØ² Ø¹Ø¨Ø¯ Ø§Ù„Ø¬Ø¨Ø§Ø± , Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø© Ù„Ù…Ù„ØªÙ‚Ù‰ Ù…ØºÙ„Ù…ÙŠ ÙˆÙ…Ø¹Ù„Ù…Ø§Øª Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª
  </footer>

<script>
/* ====== Ù…Ø±Ø§Ø¬Ø¹ Ø¹Ø§Ù…Ø© ====== */
const board = document.getElementById('board');
const overlay = document.getElementById('overlay');
const gridCanvas = document.getElementById('gridCanvas');
const axisCanvas = document.getElementById('axisCanvas');
const numberLineCanvas = document.getElementById('numberLineCanvas');
const draw = document.getElementById('draw');
const dctx = draw.getContext('2d');

let drawingOn=false, isErasing=false, isHighlighter=false;
let brushColor = document.getElementById('color').value;
let brushSize = +document.getElementById('size').value;
let startX=0,startY=0,drawing=false;
let history=[], redoStack=[];
let selectedEl=null;

/* ====== Ø§Ù„Ø®Ù„ÙÙŠØ©: Ø§Ù„Ù„ÙˆÙ† + Ø§Ù„Ù†Ù…Ø· (Ø§ÙØªØ±Ø§Ø¶ÙŠ: Ø£Ø¨ÙŠØ¶ + Ø³Ø§Ø¯Ø©) ====== */
let theme='light';        // light / dark
let bgPattern='plain';    // striped / plain
function applyDrawBackground(){
  if(bgPattern==='plain'){
    draw.style.background = 'transparent'; // ØªØ¸Ù‡Ø± Ø®Ù„ÙÙŠØ© Ø§Ù„Ù„ÙˆØ­Ø© (Ø£Ø¨ÙŠØ¶/Ø£Ø³ÙˆØ¯) Ø¨Ù„Ø§ Ø®Ø·ÙˆØ·
  }else{
    draw.style.background = (theme==='dark')
      ? 'repeating-linear-gradient(0deg, rgba(255,255,255,0.06) 0 24px, transparent 24px 48px)'
      : 'repeating-linear-gradient(0deg, rgba(0,0,0,0.03) 0 24px, transparent 24px 48px)';
  }
}
document.getElementById('bgSelect').addEventListener('change',(e)=>{
  theme = e.target.value;
  board.classList.toggle('theme-dark', theme==='dark');
  applyDrawBackground();
  redrawAll();
});
document.getElementById('patternSelect').addEventListener('change',(e)=>{
  bgPattern = e.target.value;
  applyDrawBackground();
});

function redrawAll(){
  drawGrid(currentGrid);
  drawAxes(currentGrid==='axis');
  drawNumberLine(showNumLine);
}

/* Ø²Ø± Ø³Ø±ÙŠØ¹: Ø®Ù„ÙÙŠØ© Ø³Ø§Ø¯Ø© 100Ùª */
document.getElementById('plainQuick').onclick = ()=>{
  document.getElementById('bgSelect').value='light';
  document.getElementById('patternSelect').value='plain';
  theme='light'; bgPattern='plain'; board.classList.remove('theme-dark'); applyDrawBackground();
  document.getElementById('gridType').value='none';
  currentGrid='none'; showNumLine=false;
  drawGrid('none'); drawAxes(false); drawNumberLine(false);
  document.getElementById('toggleNumLine').classList.remove('active');
};

/* ====== ØªØ­Ø¯ÙŠØ¯/Ø­Ø°Ù Ø¹Ø§Ù… ====== */
function selectEl(el){ if(selectedEl) selectedEl.classList.remove('selected'); selectedEl=el; if(el) el.classList.add('selected'); updateDeleteBtn(); }
function deselect(){ if(selectedEl) selectedEl.classList.remove('selected'); selectedEl=null; updateDeleteBtn(); }
function updateDeleteBtn(){ document.getElementById('deleteEl').disabled=!selectedEl; }
document.getElementById('deleteEl').onclick=()=>{ if(!selectedEl) return; if(selectedEl.id==='ruler'||selectedEl.id==='protractor'){ selectedEl.style.display='none'; } else { selectedEl.remove(); } deselect(); };
document.addEventListener('keydown',(e)=>{ if((e.key==='Delete'||e.key==='Backspace') && selectedEl && !['INPUT','TEXTAREA'].includes(document.activeElement.tagName)){ document.getElementById('deleteEl').click(); }});

/* ====== ØªØºÙŠÙŠØ± Ù…Ù‚Ø§Ø³ Ø§Ù„Ù„ÙˆØ­Ø© ====== */
function resizeAll(){
  const r = board.getBoundingClientRect();
  [gridCanvas, axisCanvas, numberLineCanvas, draw].forEach(c=>{ const data=c===draw ? dctx.getImageData(0,0,c.width||1,c.height||1) : null; c.width=r.width; c.height=r.height; if(c===draw && data && data.width>1){ dctx.putImageData(data,0,0); }});
  applyDrawBackground();
  redrawAll();
}
window.addEventListener('resize', resizeAll);
setTimeout(resizeAll,0);

/* ====== Ø§Ù„Ø±Ø³Ù… Ø§Ù„Ø­Ø± ====== */
function pushHistory(){ try{ history.push(draw.toDataURL()); if(history.length>40) history.shift(); redoStack=[]; }catch(e){} }
function restore(dataURL){ if(!dataURL){ dctx.clearRect(0,0,draw.width,draw.height); return; } const img=new Image(); img.onload=()=>{ dctx.clearRect(0,0,draw.width,draw.height); dctx.drawImage(img,0,0,draw.width,draw.height); }; img.src=dataURL; }
board.addEventListener('pointerdown', e=>{
  if(e.target.closest('.draggable')||e.target.closest('#wheelBox')) return;
  deselect();
  const rect=draw.getBoundingClientRect(); const x=e.clientX-rect.left; const y=e.clientY-rect.top;
  startX=x; startY=y; if(drawingOn){ drawing=true; dctx.beginPath(); dctx.moveTo(x,y); }
});
board.addEventListener('pointermove', e=>{
  if(e.target.closest('.draggable')||e.target.closest('#wheelBox')) return;
  const rect=draw.getBoundingClientRect(); const x=e.clientX-rect.left; const y=e.clientY-rect.top;
  if(drawingOn && drawing){
    dctx.lineCap='round'; dctx.lineJoin='round'; dctx.lineWidth=brushSize;
    if(isErasing){ dctx.globalCompositeOperation='destination-out'; dctx.strokeStyle='rgba(0,0,0,1)'; }
    else{ dctx.globalCompositeOperation='source-over'; dctx.strokeStyle=brushColor; dctx.globalAlpha=isHighlighter?0.3:1.0; }
    dctx.lineTo(x,y); dctx.stroke(); dctx.beginPath(); dctx.moveTo(x,y);
  }
});
board.addEventListener('pointerup', ()=>{ if(drawing){ drawing=false; pushHistory(); } dctx.globalAlpha=1; dctx.globalCompositeOperation='source-over'; });

document.getElementById('toggleDraw').onclick=e=>{ drawingOn=!drawingOn; e.currentTarget.classList.toggle('active',drawingOn); e.currentTarget.textContent=drawingOn?'âœï¸ Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø±Ø³Ù…':'âœï¸ ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø±Ø³Ù…'; };
document.getElementById('eraser').onclick=e=>{ isErasing=!isErasing; isHighlighter=false; e.currentTarget.classList.toggle('active',isErasing); document.getElementById('hl').classList.remove('active'); };
document.getElementById('hl').onclick=e=>{ isHighlighter=!isHighlighter; isErasing=false; e.currentTarget.classList.toggle('active',isHighlighter); document.getElementById('eraser').classList.remove('active'); };
document.getElementById('color').oninput=e=> brushColor=e.target.value;
document.getElementById('size').oninput=e=> brushSize=+e.target.value;
document.getElementById('clear').onclick=()=>{ dctx.clearRect(0,0,draw.width,draw.height); pushHistory(); };
document.getElementById('save').onclick=()=>{ const a=document.createElement('a'); a.download='math-whiteboard.png'; a.href=draw.toDataURL('image/png'); a.click(); };
document.getElementById('undo').onclick=()=>{ if(history.length>0){ const last=history.pop(); redoStack.push(last); const prev=history[history.length-1]; if(prev) restore(prev); else dctx.clearRect(0,0,draw.width,draw.height);} };
document.getElementById('redo').onclick=()=>{ const d=redoStack.pop(); if(d){ history.push(d); restore(d);} };

/* ====== Ø§Ù„Ø´Ø¨ÙƒØ§Øª ÙˆØ§Ù„Ù…Ø­Ø§ÙˆØ± ====== */
let currentGrid='none', showNumLine=false;
function gridColor(){ return theme==='dark' ? 'rgba(255,255,255,.20)' : 'rgba(0,0,0,.12)'; }
function axisColor(){ return theme==='dark' ? '#e5e7eb' : '#111'; }
function textColor(){ return theme==='dark' ? '#e5e7eb' : '#111'; }
function drawGrid(type){
  const g=gridCanvas.getContext('2d'); g.clearRect(0,0,gridCanvas.width,gridCanvas.height);
  if(type==='none'||type==='axis') return; const w=gridCanvas.width,h=gridCanvas.height; g.strokeStyle=gridColor(); g.lineWidth=1;
  if(type==='square'){ const step=60; for(let x=0;x<w;x+=step){ g.beginPath(); g.moveTo(x,0); g.lineTo(x,h); g.stroke(); } for(let y=0;y<h;y+=step){ g.beginPath(); g.moveTo(0,y); g.lineTo(w,y); g.stroke(); } }
  else if(type==='dots'){ const step=40; for(let x=0;x<w;x+=step){ for(let y=0;y<h;y+=step){ g.beginPath(); g.arc(x,y,1.6,0,Math.PI*2); g.fillStyle=gridColor(); g.fill(); } } }
  else if(type==='iso'){ const step=34; const hstep=Math.sqrt(3)/2*step; g.strokeStyle=gridColor(); for(let y=0;y<h;y+=hstep){ g.beginPath(); g.moveTo(0,y); g.lineTo(w,y); g.stroke(); for(let x=0;x<w;x+=step){ g.beginPath(); g.moveTo(x,y); g.lineTo(x+step/2,y+hstep); g.stroke(); g.beginPath(); g.moveTo(x,y); g.lineTo(x-step/2,y+hstep); g.stroke(); } } }
}
function drawAxes(show){
  const a=axisCanvas.getContext('2d'); a.clearRect(0,0,axisCanvas.width,axisCanvas.height); if(!show) return;
  const w=axisCanvas.width,h=axisCanvas.height; const cx=w/2,cy=h/2; a.strokeStyle=axisColor(); a.lineWidth=2; a.fillStyle=textColor();
  a.beginPath(); a.moveTo(0,cy); a.lineTo(w,cy); a.stroke();
  a.beginPath(); a.moveTo(cx,0); a.lineTo(cx,h); a.stroke();
  for(let x=cx+50;x<w;x+=50){ a.beginPath(); a.moveTo(x,cy-6); a.lineTo(x,cy+6); a.stroke(); }
  for(let x=cx-50;x>0;x-=50){ a.beginPath(); a.moveTo(x,cy-6); a.lineTo(x,cy+6); a.stroke(); }
  for(let y=cy+50;y<h;y+=50){ a.beginPath(); a.moveTo(cx-6,y); a.lineTo(cx+6,y); a.stroke(); }
  for(let y=cy-50;y>0;y-=50){ a.beginPath(); a.moveTo(cx-6,y); a.lineTo(cx+6,y); a.stroke(); }
}
function drawNumberLine(show){
  const n=numberLineCanvas.getContext('2d'); n.clearRect(0,0,numberLineCanvas.width,numberLineCanvas.height); if(!show) return;
  const w=numberLineCanvas.width,h=numberLineCanvas.height; const y=h-60; n.strokeStyle=axisColor(); n.lineWidth=2; n.fillStyle=textColor();
  n.beginPath(); n.moveTo(50,y); n.lineTo(w-30,y); n.stroke();
  n.beginPath(); n.moveTo(w-30,y); n.lineTo(w-45,y-8); n.lineTo(w-45,y+8); n.closePath(); n.fill();
  const start=50, step=40; let val=0; n.textAlign='center'; n.font='14px Arial';
  for(let x=start;x<w-40;x+=step){ n.beginPath(); n.moveTo(x,y-10); n.lineTo(x,y+10); n.stroke(); n.fillText(val.toString(), x, y+26); val++; }
}
document.getElementById('gridType').onchange=e=>{ currentGrid=e.target.value; redrawAll(); };
document.getElementById('toggleNumLine').onclick=e=>{ showNumLine=!showNumLine; e.currentTarget.classList.toggle('active',showNumLine); drawNumberLine(showNumLine); };

/* ====== ØµÙ†Ø§Ø¯ÙŠÙ‚ Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„ØªØ­Ø¬ÙŠÙ… (ØµÙˆØ±/Ø£Ø´ÙƒØ§Ù„) ====== */
function addResizeHandles(el){
  ['nw','ne','sw','se'].forEach(pos=>{
    const h=document.createElement('div'); h.className=`resize-handle handle-${pos}`; h.dataset.pos=pos; el.appendChild(h);
  });
}
function makeResizable(el, keepRatio=false){
  addResizeHandles(el);
  el.addEventListener('pointerdown', (e)=>{
    if(e.target.classList.contains('resize-handle') || e.target.classList.contains('framebar')) return;
    startDrag(e, el);
  });
  el.querySelectorAll('.resize-handle').forEach(h=>{
    h.addEventListener('pointerdown', (e)=>{
      e.stopPropagation(); e.preventDefault();
      const rect=el.getBoundingClientRect(); const boardRect=board.getBoundingClientRect();
      const startW=rect.width, startH=rect.height;
      const startL=rect.left-boardRect.left, startT=rect.top-boardRect.top;
      const sx=e.clientX, sy=e.clientY; const pos=h.dataset.pos;
      const ratio=startW/startH;
      function onMove(ev){
        let dx=ev.clientX-sx, dy=ev.clientY-sy;
        let newW=startW, newH=startH, newL=startL, newT=startT;
        if(pos.includes('e')) newW = Math.max(40, startW + dx);
        if(pos.includes('s')) newH = Math.max(40, startH + dy);
        if(pos.includes('w')){ newW = Math.max(40, startW - dx); newL = startL + dx; }
        if(pos.includes('n')){ newH = Math.max(40, startH - dy); newT = startT + dy; }
        if(keepRatio){
          if(newW/newH > ratio){ newW = newH * ratio; } else { newH = newW / ratio; }
        }
        el.style.width = newW + 'px';
        el.style.height = newH + 'px';
        el.style.left = newL + 'px';
        el.style.top  = newT + 'px';
      }
      function onUp(){ document.removeEventListener('pointermove', onMove); document.removeEventListener('pointerup', onUp); }
      document.addEventListener('pointermove', onMove);
      document.addEventListener('pointerup', onUp);
    });
  });
}
function startDrag(e, el){
  selectEl(el);
  const boardRect = board.getBoundingClientRect();
  const rect = el.getBoundingClientRect();
  const sx = e.clientX, sy = e.clientY;
  const startL = rect.left - boardRect.left;
  const startT = rect.top - boardRect.top;
  function onMove(ev){
    el.style.left = (startL + (ev.clientX - sx)) + 'px';
    el.style.top  = (startT + (ev.clientY - sy)) + 'px';
  }
  function onUp(){ document.removeEventListener('pointermove', onMove); document.removeEventListener('pointerup', onUp); }
  document.addEventListener('pointermove', onMove);
  document.addEventListener('pointerup', onUp);
}

/* ØµÙˆØ± */
document.getElementById('imgInput').onchange = (e)=>{
  const f=e.target.files[0]; if(!f) return;
  const url=URL.createObjectURL(f);
  const box=document.createElement('div');
  box.className='draggable box image'; box.style.width='360px'; box.style.height='240px';
  const img=new Image(); img.src=url; box.appendChild(img);
  overlay.appendChild(box);
  makeResizable(box, true);
  selectEl(box);
};

/* Ø£Ø´ÙƒØ§Ù„: Ù…Ø±Ø¨Ø¹ ÙˆÙ…Ø³ØªØ·ÙŠÙ„ */
function addShapeSquare(){
  const box=document.createElement('div');
  box.className='draggable box shape square'; box.style.width='180px'; box.style.height='180px';
  overlay.appendChild(box); makeResizable(box, true); selectEl(box);
}
function addShapeRect(){
  const box=document.createElement('div');
  box.className='draggable box shape'; box.style.width='260px'; box.style.height='140px';
  overlay.appendChild(box); makeResizable(box, false); selectEl(box);
}
document.getElementById('addSquare').onclick=addShapeSquare;
document.getElementById('addRect').onclick=addShapeRect;

/* Ù†ØµÙˆØµ */
document.getElementById('textNote').onclick=()=>{
  const txt=prompt('Ø§ÙƒØªØ¨ Ø§Ù„Ù†Øµ:');
  if(!txt) return;
  const el=document.createElement('div');
  el.className='draggable box'; el.style.padding='8px 12px'; el.style.background='#fff8c5'; el.style.border='1px solid #fcd34d';
  el.textContent=txt; overlay.appendChild(el); makeResizable(el,false); selectEl(el);
};
document.getElementById('textEraser').onclick=(e)=>{ const on=e.currentTarget.classList.toggle('active'); if(on){ overlay.addEventListener('click', textEraserHandler, {once:true}); } };
function textEraserHandler(ev){ const el=ev.target.closest('.box'); if(el) el.remove(); document.getElementById('textEraser').classList.remove('active'); }
document.getElementById('clearNotes').onclick=()=>{ if(confirm('Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù†ØµÙˆØµØŸ')){ overlay.querySelectorAll('.box').forEach(n=>{ if(!n.id || (n.id!=='geoboardBox' && n.id!=='polypadBox' && n.id!=='viewerBox' && n.id!=='ruler' && n.id!=='protractor')) n.remove(); }); deselect(); }};

/* Ø¹Ø¬Ù„Ø© Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ */
const wheelBox=document.getElementById('wheelBox'); const wheelCanvas=document.getElementById('wheelCanvas'); const wctx=wheelCanvas.getContext('2d');
let names=[], isSpinning=false, rotation=0, lastWinner=null;
function drawWheel(){
  const w=wheelCanvas.width,h=wheelCanvas.height; wctx.clearRect(0,0,w,h); wctx.save(); wctx.translate(w/2,h/2);
  const count=names.length||1; const colors=['#ef4444','#f59e0b','#10b981','#3b82f6','#8b5cf6','#ec4899','#14b8a6','#f97316']; const angle=Math.PI*2/count;
  for(let i=0;i<count;i++){ wctx.beginPath(); wctx.moveTo(0,0); wctx.arc(0,0,120,i*angle+rotation,(i+1)*angle+rotation); wctx.closePath(); wctx.fillStyle=colors[i%colors.length]; wctx.fill();
    wctx.save(); wctx.rotate(i*angle+rotation+angle/2); wctx.textAlign='center'; wctx.fillStyle='#fff'; wctx.font='14px Arial'; const label=names[i]||'â€”'; wctx.fillText(label,70,6); wctx.restore(); }
  wctx.restore(); wctx.fillStyle='#111'; wctx.beginPath(); wctx.moveTo(w/2,10); wctx.lineTo(w/2-12,28); wctx.lineTo(w/2+12,28); wctx.closePath(); wctx.fill();
}
drawWheel();
document.getElementById('toggleWheel').onclick=e=>{ const show=wheelBox.style.display!=='block'; wheelBox.style.display=show?'block':'none'; e.currentTarget.classList.toggle('active',show); drawWheel(); };
document.getElementById('names').addEventListener('input', e=>{ names=e.target.value.split(/\n/).map(s=>s.trim()).filter(Boolean); drawWheel(); });
document.getElementById('clearNames').onclick=()=>{ document.getElementById('names').value=''; names=[]; drawWheel(); setWinner(''); };
document.getElementById('removeWin').onclick=()=>{ if(!lastWinner) return; names=names.filter(n=>n!==lastWinner); document.getElementById('names').value=names.join('\n'); setWinner(''); drawWheel(); };
function setWinner(text){ const w=document.getElementById('winner'); w.textContent=text?('Ø§Ù„ÙØ§Ø¦Ø²: '+text):''; lastWinner=text||null; }
document.getElementById('spin').onclick=()=>{
  if(isSpinning||names.length===0) return; isSpinning=true; const spins=5+Math.floor(Math.random()*5); const randomAngle=Math.random()*Math.PI*2; const total=spins*Math.PI*2+randomAngle; const duration=3000; const start=performance.now(); const startRot=rotation;
  function anim(t){ const p=Math.min(1,(t-start)/duration); const ease=1-Math.pow(1-p,3); rotation=startRot+total*ease; drawWheel(); if(p<1) requestAnimationFrame(anim); else{ const count=names.length; const angle=Math.PI*2/count; const pos=(Math.PI*1.5-rotation)%(Math.PI*2); const index=Math.floor(((pos<0?pos+Math.PI*2:pos))/angle); const win=names[(index+count)%count]; setWinner(win); isSpinning=false; } }
  requestAnimationFrame(anim);
};

/* Ø§Ù„Ù…Ø³Ø·Ø±Ø© ÙˆØ§Ù„Ù…Ù†Ù‚Ù„Ø©: Ø¨Ù†Ø§Ø¡ Ø§Ù„Ø¹Ù„Ø§Ù…Ø§Øª */
(function buildRuler(){
  const g=document.querySelector('#ruler #ticks'); const w=580; const startX=10;
  for(let i=0;i<=300;i++){ const px=startX + i*(w/300); const h=(i%10===0)?24:(i%5===0?16:10);
    const line=document.createElementNS('http://www.w3.org/2000/svg','line'); line.setAttribute('x1',px); line.setAttribute('y1',6);
    line.setAttribute('x2',px); line.setAttribute('y2',6+h); line.setAttribute('stroke','#111'); line.setAttribute('stroke-width',1); g.appendChild(line);
    if(i%10===0){ const t=document.createElementNS('http://www.w3.org/2000/svg','text'); t.setAttribute('x',px+2); t.setAttribute('y',46);
      t.setAttribute('font-size','12'); t.setAttribute('fill','#111'); t.textContent=(i/10).toString(); g.appendChild(t); }
  }
})();
(function buildProtractor(){
  const g=document.querySelector('#protractor #pticks'); const cx=200, cy=200, R=190;
  for(let d=0; d<=180; d++){ const rad=(Math.PI/180)*d;
    const x1=cx+Math.cos(Math.PI-rad)*R; const y1=cy-Math.sin(Math.PI-rad)*R;
    const len=(d%10===0)?16:(d%5===0?10:6);
    const x2=cx+Math.cos(Math.PI-rad)*(R-len); const y2=cy-Math.sin(Math.PI-rad)*(R-len);
    const line=document.createElementNS('http://www.w3.org/2000/svg','line'); line.setAttribute('x1',x1); line.setAttribute('y1',y1);
    line.setAttribute('x2',x2); line.setAttribute('y2',y2); line.setAttribute('stroke','#1f2937'); line.setAttribute('stroke-width',1); g.appendChild(line);
    if(d%10===0){ const lx=cx+Math.cos(Math.PI-rad)*(R-28); const ly=cy-Math.sin(Math.PI-rad)*(R-28);
      const t=document.createElementNS('http://www.w3.org/2000/svg','text'); t.setAttribute('x',lx); t.setAttribute('y',ly);
      t.setAttribute('font-size','11'); t.setAttribute('fill','#111'); t.setAttribute('text-anchor','middle'); t.textContent=d.toString(); g.appendChild(t); }
  }
})();

/* ====== Ø¥Ø¯Ø±Ø§Ø¬ Ù…Ù„Ù/Ù…Ø³ØªÙ†Ø¯ ====== */
const insertFileBtn = document.getElementById('insertFile');
const insertFileLinkBtn = document.getElementById('insertFileLink');
const filePicker = document.getElementById('filePicker');

insertFileBtn.onclick = ()=> filePicker.click();
insertFileLinkBtn.onclick = ()=>{
  const raw = prompt('Ø£Ù„ØµÙ‚ Ø±Ø§Ø¨Ø· Ù…Ù„Ù PDF/Word/Excel/PowerPoint:');
  if(raw) createDocFromLink(raw.trim());
};

filePicker.onchange = (e)=>{
  const f = e.target.files[0];
  if(!f) return;
  const name = f.name;
  const ext = (name.split('.').pop()||'').toLowerCase();
  const url = URL.createObjectURL(f);

  if(ext === 'pdf'){
    createDocBox({ title: 'PDF: '+name, embed:url, open:url, hint:'ÙŠÙ…ÙƒÙ†Ùƒ Ø³Ø­Ø¨ Ø§Ù„Ù…Ø±Ø¨Ø¹ ÙˆØªÙƒØ¨ÙŠØ±Ù‡ Ù…Ù† Ø§Ù„Ø²ÙˆØ§ÙŠØ§.' });
  }else if(['doc','docx','ppt','pptx','xls','xlsx'].includes(ext)){
    const box = createDocBox({ title:'Ù…Ù„Ù Office: '+name, embed:null, open:url, hint:'Ù„Ø¹Ø±Ø¶ Word/Excel/PowerPoint Ø¶Ù…Ù† Ø§Ù„Ø³Ø¨ÙˆØ±Ø© Ù†Ø­ØªØ§Ø¬ Ø±Ø§Ø¨Ø·Ù‹Ø§ Ø¹Ù„Ù†ÙŠÙ‹Ø§Ø› Ø§ÙØªØ­/Ù†Ø²Ù‘Ù„ Ø§Ù„Ù…Ù„Ù Ø£Ùˆ Ø§Ù„ØµÙ‚ Ø±Ø§Ø¨Ø·Ù‹Ø§ Ø¹Ù„Ù†ÙŠÙ‹Ø§ Ù„ÙŠÙØ¹Ø±Ø¶ Ø¹Ø¨Ø± Office Online.' });
    const inner = document.createElement('div');
    inner.style.cssText='position:absolute; top:36px; left:0; right:0; bottom:0; padding:14px; overflow:auto; background:#fff; border-bottom-left-radius:12px; border-bottom-right-radius:12px;';
    inner.innerHTML = '<p>âš ï¸ <b>ØªÙ†Ø¨ÙŠÙ‡:</b> Ø¹Ø±Ø¶ Ù…Ù„ÙØ§Øª Ø£ÙˆÙÙŠØ³ Ø§Ù„Ù…Ø­Ù„ÙŠØ© Ø¯Ø§Ø®Ù„ Ø¥Ø·Ø§Ø± Ø§Ù„Ù…ØªØµÙØ­ ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ… Ù…Ø¨Ø§Ø´Ø±Ø©.</p>\
    <p><a href="'+url+'" target="_blank" rel="noopener">ğŸ“¥ ÙØªØ­/ØªÙ†Ø²ÙŠÙ„ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù…Ø­Ù„ÙŠ</a></p>\
    <div style="margin-top:8px; display:flex; gap:6px; flex-wrap:wrap;">\
      <input id="officeLinkInput" class="input" style="flex:1; min-width:260px" placeholder="Ø§Ù„ØµÙ‚ÙŠ Ø±Ø§Ø¨Ø·Ù‹Ø§ Ù…Ø¨Ø§Ø´Ø±Ù‹Ø§ Ù„Ù„Ù…Ù„Ù (https://...)">\
      <button id="officeLinkBtn" class="button">ØªØ¶Ù…ÙŠÙ†</button>\
    </div>\
    <small class="hint">Ù†ØµÙŠØ­Ø©: Ø§Ø±ÙØ¹ÙŠ Ø§Ù„Ù…Ù„Ù Ø¥Ù„Ù‰ OneDrive/Google Drive/Dropbox ÙˆØ®Ø°ÙŠ Ø±Ø§Ø¨Ø·Ù‹Ø§ Ù…Ø¨Ø§Ø´Ø±Ù‹Ø§.</small>';
    box.appendChild(inner);
    inner.querySelector('#officeLinkBtn').onclick = ()=>{
      const link = inner.querySelector('#officeLinkInput').value.trim();
      if(link) createDocFromLink(link);
    };
  }else{
    alert('Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ… Ù„Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©. ÙŠÙÙØ¶Ù‘Ù„ PDF Ø£Ùˆ Ø±Ø§Ø¨Ø· Ù…Ù„Ù Ø£ÙˆÙÙŠØ³ Ø¹Ù„Ù†ÙŠ.');
  }
  e.target.value='';
};

function createDocFromLink(link){
  const {embed, open} = toDocEmbed(link);
  createDocBox({ title:'Ù…Ø³ØªÙ†Ø¯', embed, open, hint:'Ù„Ùˆ Ù„Ù… ÙŠØ¹Ø±Ø¶ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ù…Ø³ØªÙ†Ø¯ Ø¯Ø§Ø®Ù„ Ø§Ù„Ø¥Ø·Ø§Ø±ØŒ Ø§Ø³ØªØ®Ø¯Ù… Ø²Ø± "ÙØªØ­ ÙÙŠ ØªØ¨ÙˆÙŠØ¨".' });
}
function toDocEmbed(u){
  try{
    const url = new URL(u);
    const clean = url.toString();
    const lower = clean.toLowerCase();
    if(lower.endsWith('.pdf')){
      return {embed: clean, open: clean};
    }
    if(/\.(doc|docx|ppt|pptx|xls|xlsx)(\?|#|$)/i.test(lower)){
      return {
        embed: 'https://view.officeapps.live.com/op/embed.aspx?src=' + encodeURIComponent(clean),
        open: clean
      };
    }
    return {
      embed: 'https://docs.google.com/gview?embedded=1&url=' + encodeURIComponent(clean),
      open: clean
    };
  }catch(e){
    return {embed:u, open:u};
  }
}
function createDocBox({title, embed, open, hint}){
  const box = document.createElement('div');
  box.className='draggable box'; box.style.cssText='width:960px; height:600px; top:120px; left:80px; z-index:26; background:#fff;';
  const bar = document.createElement('div');
  bar.className='framebar';
  bar.innerHTML = '<span class="title">'+(title||'Ù…Ø³ØªÙ†Ø¯')+'</span><span class="grow"></span>' +
                  (open?'<a href="'+open+'" target="_blank" rel="noopener">ÙØªØ­ ÙÙŠ ØªØ¨ÙˆÙŠØ¨</a>':'') +
                  '<button class="close">Ø¥ØºÙ„Ø§Ù‚ Ã—</button>';
  const frame = document.createElement('iframe');
  frame.className='frame'; frame.referrerPolicy='no-referrer'; frame.allowFullscreen=true;
  if(embed) frame.src = embed;
  const foot = document.createElement('div');
  foot.className='hint'; foot.style.position='absolute'; foot.style.left='12px'; foot.style.right='12px'; foot.style.bottom='12px';
  foot.innerHTML = hint || 'ÙŠÙ…ÙƒÙ†Ùƒ Ø³Ø­Ø¨ Ø§Ù„Ù…Ø±Ø¨Ø¹ ÙˆØªÙƒØ¨ÙŠØ±Ù‡ Ù…Ù† Ø§Ù„Ø²ÙˆØ§ÙŠØ§.';

  box.appendChild(bar); if(embed) box.appendChild(frame); box.appendChild(foot);
  overlay.appendChild(box);
  bar.addEventListener('pointerdown', (e)=>{
    selectEl(box);
    const boardRect = board.getBoundingClientRect();
    const rect = box.getBoundingClientRect();
    const sx = e.clientX, sy = e.clientY;
    const startL = rect.left - boardRect.left;
    const startT = rect.top - boardRect.top;
    function onMove(ev){
      box.style.left = (startL + (ev.clientX - sx)) + 'px';
      box.style.top  = (startT + (ev.clientY - sy)) + 'px';
    }
    function onUp(){ document.removeEventListener('pointermove', onMove); document.removeEventListener('pointerup', onUp); }
    document.addEventListener('pointermove', onMove);
    document.addEventListener('pointerup', onUp);
  });
  bar.querySelector('.close').onclick = ()=> box.remove();
  makeResizable(box, false);
  selectEl(box);
  return box;
}

/* ====== Ø§Ù„Ø¹Ø§Ø±Ø¶ Ø§Ù„Ø¹Ø§Ù… Ù„Ù„Ø±ÙˆØ§Ø¨Ø· + Ø§Ù„Ø¨Ø­Ø« ====== */
const viewerBox = document.getElementById('viewerBox');
const viewerBar = document.getElementById('viewerbar');
const viewer = document.getElementById('viewer');
const viewerURL = document.getElementById('viewerURL');
const viewerOpen = document.getElementById('viewerOpen');
document.getElementById('viewerClose').onclick = ()=>{ viewerBox.style.display='none'; };

function isURL(s){ try{ new URL(s); return true; } catch(e){ return false; } }
function qsel(id){ return document.getElementById(id); }

function openInViewer(raw){
  if(!raw) return;
  if(!isURL(raw)){
    window.open('https://www.google.com/search?q='+encodeURIComponent(raw),'_blank');
    return;
  }
  viewer.src = 'about:blank';
  viewer.src = raw;
  viewerURL.textContent = raw;
  viewerOpen.href = raw;
  viewerBox.style.display='block';
  selectEl(viewerBox);
}
qsel('openURL').onclick = ()=> openInViewer(qsel('urlInput').value.trim());
qsel('urlInput').addEventListener('keydown', e=>{ if(e.key==='Enter') openInViewer(e.target.value.trim()); });
qsel('searchWeb').onclick = ()=>{ const q=qsel('webQuery').value.trim(); if(q) window.open('https://www.google.com/search?q='+encodeURIComponent(q),'_blank'); };
qsel('webQuery').addEventListener('keydown', e=>{ if(e.key==='Enter') qsel('searchWeb').click(); });
qsel('searchYT').onclick = ()=>{
  const q=qsel('ytQuery').value.trim();
  if(!q) return;
  if(isURL(q)) openInViewer(q);
  else window.open('https://www.youtube.com/results?search_query='+encodeURIComponent(q),'_blank');
};
qsel('ytQuery').addEventListener('keydown', e=>{ if(e.key==='Enter') qsel('searchYT').click(); });

viewerBar.addEventListener('pointerdown', (e)=>{
  selectEl(viewerBox);
  const boardRect = board.getBoundingClientRect();
  const rect = viewerBox.getBoundingClientRect();
  const sx = e.clientX, sy = e.clientY;
  const startL = rect.left - boardRect.left;
  const startT = rect.top - boardRect.top;
  function onMove(ev){
    viewerBox.style.left = (startL + (ev.clientX - sx)) + 'px';
    viewerBox.style.top  = (startT + (ev.clientY - sy)) + 'px';
  }
  function onUp(){ document.removeEventListener('pointermove', onMove); document.removeEventListener('pointerup', onUp); }
  document.addEventListener('pointermove', onMove);
  document.addEventListener('pointerup', onUp);
});
makeResizable(viewerBox, false);

/* ====== Polypad Ùˆ Geoboard ====== */
const polyBtn = document.getElementById('togglePolypad');
const polyBox = document.getElementById('polypadBox');
const polyBar = document.getElementById('polybar');
const polyIframe = document.getElementById('polyframe');
document.getElementById('polyClose').onclick = ()=>{ polyBox.style.display='none'; polyBtn.classList.remove('active'); };
polyBtn.onclick = (e)=>{
  const show = polyBox.style.display !== 'block';
  polyBox.style.display = show ? 'block' : 'none';
  e.currentTarget.classList.toggle('active', show);
  if(show){ selectEl(polyBox); if(!polyIframe.src || polyIframe.src==='about:blank') polyIframe.src='https://polypad.amplify.com/p'; }
};
polyBar.addEventListener('pointerdown', (e)=>{
  selectEl(polyBox);
  const boardRect = board.getBoundingClientRect();
  const rect = polyBox.getBoundingClientRect();
  const sx = e.clientX, sy = e.clientY;
  const startL = rect.left - boardRect.left;
  const startT = rect.top - boardRect.top;
  function onMove(ev){
    polyBox.style.left = (startL + (ev.clientX - sx)) + 'px';
    polyBox.style.top  = (startT + (ev.clientY - sy)) + 'px';
  }
  function onUp(){ document.removeEventListener('pointermove', onMove); document.removeEventListener('pointerup', onUp); }
  document.addEventListener('pointermove', onMove);
  document.addEventListener('pointerup', onUp);
});
makeResizable(polyBox, false);

const geoBtn = document.getElementById('toggleGeoboard');
const geoBox = document.getElementById('geoboardBox');
const geoBar = document.getElementById('geobar');
document.getElementById('geoClose').onclick = ()=>{ geoBox.style.display='none'; geoBtn.classList.remove('active'); };
geoBtn.onclick = (e)=>{
  const show = geoBox.style.display !== 'block';
  geoBox.style.display = show ? 'block' : 'none';
  e.currentTarget.classList.toggle('active', show);
  if(show){ selectEl(geoBox); }
};
geoBar.addEventListener('pointerdown', (e)=>{
  selectEl(geoBox);
  const boardRect = board.getBoundingClientRect();
  const rect = geoBox.getBoundingClientRect();
  const sx = e.clientX, sy = e.clientY;
  const startL = rect.left - boardRect.left;
  const startT = rect.top - boardRect.top;
  function onMove(ev){
    geoBox.style.left = (startL + (ev.clientX - sx)) + 'px';
    geoBox.style.top  = (startT + (ev.clientY - sy)) + 'px';
  }
  function onUp(){ document.removeEventListener('pointermove', onMove); document.removeEventListener('pointerup', onUp); }
  document.addEventListener('pointermove', onMove);
  document.addEventListener('pointerup', onUp);
});
makeResizable(geoBox, false);

/* ØªÙ‡ÙŠØ¦Ø©: Ø§ÙØªØ±Ø§Ø¶ÙŠ Ø£Ø¨ÙŠØ¶/Ø³Ø§Ø¯Ø© + Ø¨Ø¯ÙˆÙ† Ø´Ø¨ÙƒØ© */
let initOnce=false; window.addEventListener('load', ()=>{ if(initOnce) return; initOnce=true; resizeAll(); applyDrawBackground(); });
</script>
</body>
</html>
